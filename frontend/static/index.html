<html>
  <head>
    <title>FastAPI Message Interface</title>
  </head>
  <body>
    <h1>FastAPI Message Interface</h1>
    <input type="text" id="inputBox" placeholder="Enter text here">
    <br><br>
    <button id="getButton">Get</button>
    <button id="insertButton">Insert</button>
    <br><br>
    <div id="getOutput">
      <h3>Best Scoring Document:</h3>
      <pre id="bestDoc"></pre>
    </div>
    <div id="insertOutput">
      <h3>Insert Status:</h3>
      <pre id="status"></pre>
    </div>

    <script>
      // Add this at the top of your script section
      console.log("Frontend loaded, checking backend connection...");
      fetch('/check-backend')
        .then(response => response.json())
        .then(data => console.log("Backend status:", data))
        .catch(err => console.error("Backend check failed:", err));

      // Remove this line or change to empty string
      // const BACKEND_URL = "http://localhost:9567";
      
      // "Get" Button: Use the proxy route instead
      document.getElementById('getButton').addEventListener('click', function(){
        fetch('/get')
          .then(response => response.json())
          .then(data => {
            console.log("Received data:", data); // Debug what we received
            
            const messages = data.messages || {};
            if (!messages || Object.keys(messages).length === 0) {
              document.getElementById('bestDoc').innerText = 'No messages available';
              return;
            }
            
            try {
              const messageKeys = Object.keys(messages);
              console.log("Message keys:", messageKeys); 
              console.log("Full messages object:", messages);
              
              // Add special handling if keys aren't numeric
              if (messageKeys.length > 0) {
                // Check if keys can be converted to numbers
                const numericKeys = messageKeys.filter(key => !isNaN(Number(key)));
                console.log("Numeric keys:", numericKeys);
                
                if (numericKeys.length > 0) {
                  // Instead of using Math.min, find the message with the most content
                  let bestId = numericKeys[0];
                  let maxLength = messages[bestId].msg_name.length;
                  
                  // Find the message with the longest text
                  numericKeys.forEach(key => {
                    const currentLength = messages[key].msg_name.length;
                    if (currentLength > maxLength) {
                      maxLength = currentLength;
                      bestId = key;
                    }
                  });
                  
                  console.log("Best ID (longest text):", bestId);
                  console.log("Looking up with key:", String(bestId));
                  
                  const bestMsg = messages[String(bestId)];
                  console.log("Retrieved message:", bestMsg);
                  
                  if (bestMsg) {
                    document.getElementById('bestDoc').innerText = JSON.stringify(bestMsg, null, 2);
                  } else {
                    // Try direct access with the key
                    document.getElementById('bestDoc').innerText = 'Using first key: ' + 
                      JSON.stringify(messages[messageKeys[0]], null, 2);
                  }
                } else {
                  // If no numeric keys, just use the first key
                  document.getElementById('bestDoc').innerText = 'Using non-numeric key: ' + 
                    JSON.stringify(messages[messageKeys[0]], null, 2);
                }
              } else {
                document.getElementById('bestDoc').innerText = 'No message keys found';
              }
            } catch (err) {
              document.getElementById('bestDoc').innerText = 'Error: ' + err.message;
              console.error("Processing error:", err);
            }
          })
          .catch(err => {
            document.getElementById('bestDoc').innerText = 'Error: ' + err;
            console.error("Fetch error:", err);
          });
      });

      // "Insert" Button: Use the proxy route instead
      document.getElementById('insertButton').addEventListener('click', function(){
        const inputText = document.getElementById('inputBox').value;
        if (!inputText) {
          document.getElementById('status').innerText = 'Please enter some text.';
          return;
        }
        const largeDoc = inputText.repeat(20);
        fetch(`/insert/${encodeURIComponent(largeDoc)}`, {  // Use the proxy route
          method: 'POST'
        })
          .then(response => response.json())
          .then(data => {
            document.getElementById('status').innerText = JSON.stringify(data, null, 2);
          })
          .catch(err => {
            document.getElementById('status').innerText = 'Error: ' + err;
          });
      });
    </script>
  </body>
</html>
