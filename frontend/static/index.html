<html>
  <head>
    <title>FastAPI Message Interface</title>
  </head>
  <body>
    <h1>FastAPI Message Interface</h1>
    <input type="text" id="inputBox" placeholder="Enter text here">
    <br><br>
    <button id="getButton">Get</button>
    <button id="insertButton">Insert</button>
    <br><br>
    <div id="getOutput">
      <h3>Best Scoring Document:</h3>
      <pre id="bestDoc"></pre>
    </div>
    <div id="insertOutput">
      <h3>Insert Status:</h3>
      <pre id="status"></pre>
    </div>

    <script>
      // Add this at the top of your script section
      console.log("Frontend loaded, checking backend connection...");
      fetch('/check-backend')
        .then(response => response.json())
        .then(data => console.log("Backend status:", data))
        .catch(err => console.error("Backend check failed:", err));
    
      // "Get" Button: Use the /get endpoint which accepts a query parameter
      document.getElementById('getButton').addEventListener('click', function(){
        const query = document.getElementById('inputBox').value;
        const url = query ? `/get?query=${encodeURIComponent(query)}` : '/get';  // Make query optional
        
        console.log("Fetching from:", url);  // Debug which URL we're using
        
        fetch(url)
          .then(response => response.json())
          .then(data => {
            console.log("Received data:", data); // Debug what we received
            
            // Check if we have messages in the correct format
            const messages = data.messages || {};
            const messageKeys = Object.keys(messages);
            
            if (messageKeys.length === 0) {
              document.getElementById('bestDoc').innerText = 'No messages available';
              return;
            }
            
            // Get the first message (backend should be returning the best match)
            const firstKey = messageKeys[0];
            const bestMsg = messages[firstKey];
            
            if (bestMsg) {
              document.getElementById('bestDoc').innerText = 
                `Best document (ID: ${bestMsg.msg_id}):\n\n${bestMsg.msg_name}`;
            } else {
              document.getElementById('bestDoc').innerText = 'Error retrieving document';
            }
          })
          .catch(err => {
            console.error("Fetch error:", err);
            document.getElementById('bestDoc').innerText = 'Error fetching data';
          });
      });

      // "Insert" Button: Use the proxy route instead
      document.getElementById('insertButton').addEventListener('click', function(){
        const inputText = document.getElementById('inputBox').value;
        if (!inputText) {
          document.getElementById('status').innerText = 'Please enter some text.';
          return;
        }
        const largeDoc = inputText.repeat(20);
        fetch(`/insert/${encodeURIComponent(largeDoc)}`, {  // Use the proxy route
          method: 'POST'
        })
          .then(response => response.json())
          .then(data => {
            document.getElementById('status').innerText = JSON.stringify(data, null, 2);
          })
          .catch(err => {
            document.getElementById('status').innerText = 'Error: ' + err;
          });
      });
    </script>
  </body>
</html>
